<?php
/**
 * Plugin Name: HP Custom Offer Processor
 * Description: Overrides HivePress offer acceptance to create a custom WooCommerce order.
 * Version: 1.7 (Payment Content Fix)
 */

// Define the generic product ID for requests
if ( ! defined( 'HP_REQUEST_PRODUCT_ID' ) ) {
    define( 'HP_REQUEST_PRODUCT_ID', 318 ); 
}

// ----------------------------------------------------------------------
// SECTION 1: CORE ORDER CREATION FUNCTION (REWRITTEN FOR ROBUSTNESS)
// ----------------------------------------------------------------------
function hp_create_order_from_offer_core( $offer_id ) {
    $current_user_id = get_current_user_id();
    
    // Initial Platform and Dependency Check
    if ( ! function_exists( 'wc_get_order' ) ) {
        return new WP_Error( 'platform_unavailable', 'WooCommerce not loaded.' );
    }
    
    $hp_order_post_type = 'hp_order';

    try {
        $offer_comment = get_comment( $offer_id );
        if ( ! $offer_comment ) { return new WP_Error( 'offer_not_found', "Offer ID {$offer_id} not found." ); }
        
        $offer_price_raw = get_comment_meta( $offer_id, 'hp_price', true );
        $offer_price = floatval( $offer_price_raw );
        $offer_status = $offer_comment->comment_approved;
        
        $request_id = $offer_comment->comment_post_ID;
        $request_title = get_the_title( $request_id );
        $product_title_for_order = 'Payment for Request: ' . ( $request_title ? $request_title : '#' . $request_id );

        if ( $offer_price <= 0 || $offer_status != 1 ) {
            $reason = ($offer_price <= 0) ? 'invalid price' : 'unapproved status';
            return new WP_Error( 'invalid_offer', "Offer ID {$offer_id} is invalid: {$reason}." );
        }

        // --- 1. Find or create HP Order Post (Unchanged Logic) ---
        $existing_hp_order_posts = get_posts( [
            'post_type'      => $hp_order_post_type, 'meta_key'    => '_hp_offer_id',
            'meta_value' => $offer_id, 'posts_per_page' => 1, 'fields'      => 'ids',
        ] );

        if ( ! empty( $existing_hp_order_posts ) ) {
            $hp_order_post_id = $existing_hp_order_posts[0];
        } else {
            $hp_order_data = [
                'post_type'    => $hp_order_post_type, 'post_status'  => 'pending',
                'post_author'  => $offer_comment->user_id, 'post_title'   => 'HP Order for Offer #' . $offer_id,
            ];
            $hp_order_post_id = wp_insert_post( $hp_order_data, true );
            
            if ( is_wp_error( $hp_order_post_id ) ) { return new WP_Error( 'hp_order_failed', 'Failed to create HP order post: ' . $hp_order_post_id->get_error_message() ); }
            
            update_post_meta( $hp_order_post_id, '_hp_offer_id', $offer_id );
            update_post_meta( $hp_order_post_id, '_hp_order_price', $offer_price );
            update_post_meta( $hp_order_post_id, '_hp_user_id', $current_user_id );
        }
        
        // --- 2. WC Product & Order Creation with Robust Error Check ---
        $hp_order_id = $hp_order_post_id;
        $product_id = intval( HP_REQUEST_PRODUCT_ID );
        $product = wc_get_product( $product_id );
        
        if ( ! $product ) { return new WP_Error( 'product_missing', "Product ID {$product_id} not found." ); }
        
        $product_base_price = floatval( $product->get_price() ); 
        if ($product_base_price <= 0) { $product_base_price = 1; } // Emergency minimum price

        // Create new WC order 
        $wc_order = wc_create_order( [ 'customer_id' => $current_user_id, 'status' => 'pending' ] );
        
        // ðŸ”¥ ROBUST ERROR CHECKING (Guarantees $wc_order is a valid WC_Order instance)
        if ( is_wp_error( $wc_order ) ) { 
            return new WP_Error( 'wc_order_creation_failed_wp', 'WooCommerce failed to create the order: ' . $wc_order->get_error_message() ); 
        }
        if ( ! ( $wc_order instanceof WC_Order ) ) {
            return new WP_Error( 'wc_order_creation_failed_null', 'WooCommerce failed to create a valid order object.' );
        }
        // END ROBUST CHECK

        $wc_order->set_order_key( 'wc_' . strtolower( wc_rand_hash() ) );
        
        // CUSTOM ORDER ITEM CREATION
        $item = new WC_Order_Item_Product();
        $item->set_props( [ 'product'  => $product, 'quantity' => 1, 'name'     => $product_title_for_order ] );
        
        // FIX: Set the price of the order item manually to the base price
        $item->set_subtotal( $product_base_price );
        $item->set_total( $product_base_price );
        
        $wc_order->add_item( $item );

        $wc_order->calculate_totals(); 
        $wc_order->update_meta_data( '_hp_order_id', $hp_order_id ); 
        update_post_meta( $hp_order_id, '_wc_order_id', $wc_order->get_id() ); 
        $wc_order->save();

        // --- 3. Manually Construct Payment URL (Fixes Redirection) ---
        $order_id = $wc_order->get_id();
        $order_key = $wc_order->get_order_key();
        
        $checkout_url = wc_get_checkout_url();

        // Construct the exact payment URL: /checkout/order-pay/{ID}?pay_for_order=true&key={KEY}
        $pay_url = add_query_arg(
            [
                'pay_for_order' => 'true', 
                'key'           => $order_key
            ],
            $checkout_url . 'order-pay/' . $order_id
        );
        
        return [ 'pay_url' => $pay_url, 'wc_order_id' => $wc_order->get_id(), 'hp_order_id' => $hp_order_id ];

    } catch ( Throwable $e ) {
        // Generic exception catcher for unexpected runtime failures
        $error_message = $e->getMessage() ?: 'No message provided (possible core dependency failure)';
        return new WP_Error( 'exception', 'Unexpected error: ' . $error_message );
    }
}


// ----------------------------------------------------------------------
// SECTION 2: HOOKS AND FILTERS 
// ----------------------------------------------------------------------

// D) CRITICAL FIX: Ensure the WooCommerce checkout content renders on the order-pay page.
function hp_force_woocommerce_endpoint_content( $content ) {
    // Only target the order-pay endpoint and check if the content is empty.
    // The endpoint is automatically detected by WC_Shortcodes::checkout()
    if ( is_wc_endpoint_url( 'order-pay' ) && empty( $content ) ) {
        // Return the shortcode output directly.
        return do_shortcode( '[woocommerce_checkout]' );
    }
    return $content;
}


// A) Hook into the HivePress function that processes the offer (High Priority)
function hp_handle_accept_offer_action( $result, $offer_id ) {
    if ( is_wp_error( $result ) ) {
        $core_result = hp_create_order_from_offer_core( $offer_id );
        if ( is_wp_error( $core_result ) ) { return $core_result; }
        return $core_result['pay_url'];
    }
    return $result;
}
add_filter( 'hivepress/v1/models/offer/accept', 'hp_handle_accept_offer_action', 5, 2 );

// B) CRITICAL FIX: Capability Filter with MAX Priority (PHP_INT_MAX)
function hp_allow_user_to_pay_for_own_unpaid_order( $allcaps, $caps, $args ) {
    if ( isset( $caps[0] ) && $caps[0] === 'pay_for_order' && isset( $args[2] ) ) {
        $order_id = absint( $args[2] );
        $order    = wc_get_order( $order_id );
        
        if ( $order && is_user_logged_in() ) {
            $current_user_id = get_current_user_id();
            $customer_id     = $order->get_customer_id();
            
            if ( $order->needs_payment() && $current_user_id === $customer_id && $customer_id !== 0 ) {
                $allcaps['pay_for_order'] = true;
            }
        }
    }
    return $allcaps;
}
add_filter( 'user_has_cap', 'hp_allow_user_to_pay_for_own_unpaid_order', PHP_INT_MAX, 3 ); // Max priority

// C) FIX: Change the payment page title
function hp_change_pay_for_order_title( $title ) {
    return 'Pay for the request';
}
add_filter( 'woocommerce_endpoint_order-pay_title', 'hp_change_pay_for_order_title' );

// ----------------------------------------------------------------------
// SECTION 3: CLIENT MARKUP (JS Modal Handler and Error Display)
// ----------------------------------------------------------------------
add_action( 'wp_footer', 'hp_accept_offer_frontend_ui', 9999 );
function hp_accept_offer_frontend_ui() {
    if ( ! is_user_logged_in() ) return;
    
    // 1. Error Display Banner (omitted for brevity, keep in file)
    if ( isset( $_GET['hp_offer_error'] ) ) {
        $error_message = sanitize_text_field( wp_unslash( $_GET['hp_offer_error'] ) );
        $display_message = 'An unexpected error occurred. Please try again.';
        if ( $error_message === 'security' ) {
            $display_message = 'Security check failed. Please refresh the page.';
        } elseif ( $error_message === 'invalid_id' ) {
            $display_message = 'Offer ID is missing.';
        } else {
             $display_message = html_entity_decode( $error_message );
        }
        ?>
        <div id="hp-redirect-error-banner" style="position:fixed; top:0; left:0; right:0; bottom:0; background:#c9302c; color:#fff; padding:10px; text-align:center; font-weight:bold; z-index:99999;">
            ERROR: <?php echo esc_html( $display_message ); ?>
        </div>
        <script>
            setTimeout(function(){
                var banner = document.getElementById('hp-redirect-error-banner');
                if (banner) banner.style.display = 'none';
                if (window.history.replaceState) {
                    var url = new URL(window.location);
                    url.searchParams.delete('hp_offer_error');
                    window.history.replaceState({}, '', url);
                }
            }, 8000);
        </script>
        <?php
    }

    // 2. The Modal HTML and Hidden Form 
    $nonce = wp_create_nonce( 'hp_accept_offer_nonce' );
    ?>
    <div id="hp-accept-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:10000;" aria-hidden="true">
        <div id="hp-accept-card" style="background:#fff; width:90%; max-width:400px; margin:100px auto; padding:20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15);" role="dialog" aria-modal="true">
            <form id="hp-accept-form" method="POST" action="<?php echo esc_url( home_url( '/' ) ); ?>">
                <h3>Confirm Offer Acceptance</h3>
                <p>Are you sure you want to accept this offer?</p>
                <input type="hidden" name="hp_accept_offer_action" value="1" />
                <input type="hidden" name="hp_accept_offer_nonce" value="<?php echo esc_attr( $nonce ); ?>" />
                <input type="hidden" name="offer_id" id="hp-form-offer-id" value="" />
                <div class="hp-accept-footer" style="margin-top:20px; text-align:right;">
                    <button class="hp-accept-btn hp-accept-btn--cancel" type="button" id="hp-accept-cancel" style="padding:10px 15px; background:#ccc; border:none; border-radius:4px; cursor:pointer;">Cancel</button>
                    <button class="hp-accept-btn hp-accept-btn--confirm" type="submit" id="hp-accept-confirm" style="padding:10px 15px; background:#0073aa; color:#fff; border:none; border-radius:4px; cursor:pointer; margin-left:10px;">Confirm & Pay</button>
                </div>
            </form>
        </div>
    </div>
    
    <script type="text/javascript">
    (function(){
        if (!window.jQuery) return;
        var $ = jQuery;
        var currentOfferId = null;

        function extractOfferIdFromForm($form, $btn) {
            var id = $form.data('id');
            if ( id ) return parseInt(id, 10);
            id = $btn.data('id') || $btn.data('offer-id') || $btn.data('object-id');
            if ( id ) return parseInt(id, 10);
            var hidden = $form.find('input[name="offer"], input[name="offer_id"], input[name="id"]').first().val();
            if ( hidden ) return parseInt(hidden, 10);
            return null;
        }
        function showModal() { $('#hp-accept-overlay').fadeIn(160).attr('aria-hidden','false'); }
        function hideModal() { $('#hp-accept-overlay').fadeOut(140).attr('aria-hidden','true'); }

        document.addEventListener('click', function(e){
            if ( e.target.closest && e.target.closest('#hp-accept-overlay') ) return;
            
            var btn = e.target.closest && e.target.closest('.hp-form--offer-accept button[type=submit]');
            if (!btn) return;
            
            e.preventDefault(); e.stopImmediatePropagation(); e.stopPropagation();
            
            var $btn = $(btn), $form = $btn.closest('form');
            currentOfferId = extractOfferIdFromForm($form, $btn);
            
            if (!currentOfferId) { 
                console.error('HP_AcceptOffer: Could not find Offer ID.');
                return; 
            }
            
            $('#hp-form-offer-id').val(currentOfferId);
            showModal();
        }, true);

        $(document).on('click', '#hp-accept-cancel', function(e){ e.preventDefault(); hideModal(); });
        $(document).on('submit', '#hp-accept-form', function(e){
            $('#hp-accept-confirm').prop('disabled', true).text('Processing...');
        });
    })();
    </script>
    <?php
}

// ----------------------------------------------------------------------
// SECTION 4: DEDICATED FORM SUBMISSION HANDLER (FIXES REDIRECTION)
// ----------------------------------------------------------------------
add_action( 'init', 'hp_process_accept_offer_submission' );
function hp_process_accept_offer_submission() {
    if ( ! isset( $_POST['hp_accept_offer_action'] ) || $_POST['hp_accept_offer_action'] !== '1' ) {
        return;
    }

    if ( ! isset( $_POST['hp_accept_offer_nonce'] ) || ! wp_verify_nonce( sanitize_key( $_POST['hp_accept_offer_nonce'] ), 'hp_accept_offer_nonce' ) ) {
        wp_safe_redirect( add_query_arg( 'hp_offer_error', 'security', home_url( $_SERVER['REQUEST_URI'] ) ) );
        exit;
    }

    if ( ! isset( $_POST['offer_id'] ) || ! is_numeric( $_POST['offer_id'] ) ) {
        wp_safe_redirect( add_query_arg( 'hp_offer_error', 'invalid_id', home_url( $_SERVER['REQUEST_URI'] ) ) );
        exit;
    }
    
    $offer_id = absint( $_POST['offer_id'] );
    
    $result = hp_create_order_from_offer_core( $offer_id );

    if ( is_wp_error( $result ) ) {
        $error_msg = urlencode( $result->get_error_message() );
        wp_safe_redirect( add_query_arg( 'hp_offer_error', $error_msg, home_url( $_SERVER['REQUEST_URI'] ) ) );
        exit;
    }

    // --- Optimized Redirection and Session Setup ---
    if ( is_array( $result ) && isset( $result['pay_url'] ) && isset( $result['wc_order_id'] ) ) {
        
        // CRITICAL SESSION FIX: Must set this for WC to know which order to load on the next page.
        if ( function_exists( 'WC' ) && WC()->session ) {
            WC()->session->set( 'order_awaiting_payment', $result['wc_order_id'] );
        }
        
        // This is the one and only redirection.
        wp_safe_redirect( $result['pay_url'] );
        exit;
    }
    // --- End Optimized Redirection ---

    wp_safe_redirect( add_query_arg( 'hp_offer_error', 'redirect_failed', home_url( $_SERVER['REQUEST_URI'] ) ) );
    exit;
}

// ----------------------------------------------------------------------
// SECTION 5: TEMPLATE INCLUDE OVERRIDE (FORCING TEMPLATE FILE)
// ----------------------------------------------------------------------

/**
 * Ensures the 'order-pay' content is injected into the page, and forces
 * the use of the theme's page.php template file to guarantee the_content()
 * is called by the theme.
 */
function hp_force_payment_template_include( $template ) {
    // 1. Check if we are precisely on the 'order-pay' endpoint.
    if ( ! is_wc_endpoint_url( 'order-pay' ) || ! is_account_page() ) {
        return $template;
    }

    global $wp, $wp_query;

    // Retrieve order data for validation.
    $order_id = isset( $wp->query_vars['order-pay'] ) ? absint( $wp->query_vars['order-pay'] ) : 0;
    $order = $order_id ? wc_get_order( $order_id ) : null;
    
    if ( ! $order ) {
        // If no order is found, return the default template for error display.
        return $template;
    }

    // 2. Adjust WP_Query flags if necessary (less critical here but good practice).
    $wp_query->is_404 = false;
    $wp_query->is_singular = true;

    // 3. Manually call the WC function that prepares the environment.
    if ( function_exists( 'wc_setup_order_pay_endpoint' ) ) {
        wc_setup_order_pay_endpoint();
    }
    
    // 4. Force the rendering of the endpoint content using the 'the_content' filter.
    // This function will now be responsible for putting the form-pay.php output into the main content area.
    add_filter( 'the_content', 'wc_page_endpoint_content', 20 );

    // 5. CRITICAL: Force the template to be the theme's standard page.php.
    // This overrides any custom HivePress/TaskHive templates that might be omitting the_content().
    $new_template = locate_template( array( 'page.php' ) );

    if ( $new_template ) {
        if ( defined( 'WP_DEBUG' ) && WP_DEBUG ) {
            error_log('[HP_MAX_INCLUDE] Forcing template to: ' . basename($new_template) . ' to ensure the_content() is called.');
        }
        return $new_template;
    }

    // Fallback: use the original template if we can't find page.php.
    return $template;
}
add_filter( 'template_include', 'hp_force_payment_template_include', PHP_INT_MAX ); // Use PHP_INT_MAX to ensure this runs last

// ----------------------------------------------------------------------
// SECTION 6: PAYMENT STATUS UPDATE (THANK YOU FALLBACK/FORCING)
// ----------------------------------------------------------------------

/**
 * Forces the order status to 'completed' after successful payment 
 * and applies the necessary custom flags for service fulfillment.
 * This overrides WooCommerce's default 'processing' status for Virtual products 
 * that are not marked as Downloadable.
 * * @param int $order_id The WooCommerce Order ID.
 */
function hp_update_order_status_after_payment( $order_id ) {
    if ( ! $order_id ) {
        return;
    }

    $order = wc_get_order( $order_id );

    if ( ! $order ) {
        return;
    }
    
    // Check if the order status is currently 'processing', 'pending', or 'on-hold'.
    // We update all paid-but-not-finalized statuses.
    if ( $order->has_status( array( 'processing', 'pending', 'on-hold' ) ) ) {

        // ðŸ”¥ CRITICAL CHANGE: Force the status to 'completed'.
        $order->update_status( 'completed', 'Payment confirmed, and order status forced to Completed as this is a virtual service request.' );
        
        // ðŸŽ¯ Your clear DB flag for confirmed payment
        $order->update_meta_data( '_hp_payment_confirmed', '1' );
        $order->save();
    }
}
add_action( 'woocommerce_thankyou', 'hp_update_order_status_after_payment' );

// ----------------------------------------------------------------------
// SECTION 7: THANK YOU PAGE TWEAKS
// ----------------------------------------------------------------------

/**
 * Removes the default 'Order Again' button from the WooCommerce 
 * "Order Received" (Thank You) page.
 */
function hp_remove_order_again_button() {
    // Check if we are on the 'Order Received' page
    if ( is_wc_endpoint_url( 'order-received' ) ) {
        
        // Remove the action that outputs the button.
        // The default priority is 10.
        remove_action( 'woocommerce_order_details_after_order_table', 'woocommerce_order_again_button' );
    }
}
add_action( 'wp_loaded', 'hp_remove_order_again_button' );